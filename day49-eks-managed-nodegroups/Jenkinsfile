pipeline {
  agent { label "docker-agent" }
  options { timestamps(); ansiColor("xterm"); timeout(time: 50, unit: "MINUTES") }
  parameters { choice(name:"ACTION", choices:["plan","apply","destroy"]); string(name:"AWS_REGION", defaultValue:"us-east-1") }
  environment { TF_IN_AUTOMATION="true" }
  stages {
    stage("Checkout"){ steps { checkout scm } }
    stage("Terraform Init/Plan"){ steps { withEnv(["AWS_DEFAULT_REGION=${params.AWS_REGION}"]) { sh "cd day49-eks-managed-nodegroups/infra && terraform init -upgrade && terraform fmt -recursive && terraform validate && terraform plan -out=tfplan" } } }
    stage("Apply (manual)"){ when { expression { return params.ACTION == "apply" } } steps { input message: "Apply EKS nodegroup changes?", ok: "Apply"; withEnv(["AWS_DEFAULT_REGION=${params.AWS_REGION}"]) { sh "cd day49-eks-managed-nodegroups/infra && terraform apply -auto-approve tfplan || terraform apply" } } }
    stage("Destroy (manual)"){ when { expression { return params.ACTION == "destroy" } } steps { input message: "Destroy EKS stack?", ok: "Destroy"; withEnv(["AWS_DEFAULT_REGION=${params.AWS_REGION}"]) { sh "cd day49-eks-managed-nodegroups/infra && terraform destroy -auto-approve || terraform destroy" } } }
  }
  post { always { cleanWs() } }
}
